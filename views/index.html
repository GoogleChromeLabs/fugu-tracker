<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fugu API Tracker</title>
  </head>
  <style>
    *,
    *:before,
    *:after {
      box-sizing: border-box;
    }

    body {
      font-family: Roboto, sans-serif;
      margin: 0;
      position: relative;
      padding: 0 3.5rem;
    }

    .cards {
      /* display: grid; */
      list-style: none;
      margin: 0;
      padding: 2rem 0;
    }

    section > h2 {
      margin: 0;
      padding: 0.5rem 0;
      position: sticky;
      top: 0;
      left: 0;
      background: white;
      z-index: 10;
    }

    section {
      padding: 1rem 0;
      background: white;
      position: relative;
    }

    section:first-of-type {
      padding-top: 0;
      margin-top: 1rem;
    }

    header p {
      opacity: 0.6;
      line-height: 1.4;
      max-width: 80ch;
    }

    .hidden {
      display: none !important;
    }

    .card {
      font-family: Roboto, sans-serif;
      box-shadow: 0px 0px 0px 0px rgba(0, 0, 0, 0.2), 0px 0px 0px 0px rgba(0, 0, 0, 0.14), 0px 0px 0px 0px rgba(0, 0, 0, 0.12);
      display: grid;
      border: 1px solid #e8eaed;
      border-radius: 4px;
      padding: 1rem;
      height: max-content;
      overflow: hidden;
      grid-gap: 0.5rem;
    }

    .card:not(.hidden):nth-of-type(even) {
      background-color: rgb(243, 244, 246);
      border-color: rgb(209, 213, 219);
    }

    .card:not(.hidden):nth-of-type(even) .card--table thead,
    .card:not(.hidden):nth-of-type(even) .card--table tr:nth-of-type(even) {
      background-color: white;
    }

    .card--tables {
      display: grid;
      grid-gap: 1rem;
    }

    @media (min-width: 475px) {
      .card--tables {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        max-width: 900px;
      }

      .table--implementation {
        grid-column: 2 / span 1;
      }
    }

    .card--header {
      display: grid;
      grid-template-columns: 1fr 1fr 1rem;
      align-items: flex-start;
      grid-gap: 1rem;
    }

    @media (min-width: 745px) {
      .card--header {
        grid-template-columns: 2.5fr 1fr 1fr 1rem;
      }
    }

    .card--title {
      font-size: 1.25em;
      line-height: 1.4;
      font-weight: 300;
      letter-spacing: 0.0125em;
      margin: 0;
      padding: 0;
      grid-column: 1 / span 3;
      word-break: break-word;
    }

    .card--available {
      display: grid;
      grid-template-columns: repeat(auto-fit, 1.5em);
      grid-gap: 0.5rem;
      align-items: center;
      /* margin-top: 0.75rem; */
      grid-column: 2 / span 1;
    }

    .pills {
      display: flex;
      flex-wrap: wrap;
      margin: -0.25rem -0.25rem;
      /* margin-top: 0.75rem; */
      grid-column: 1 / span 1;
    }

    .card--more:not(.card--title) {
      display: flex;
      cursor: pointer;
      color: #6200ee;
      margin: 0;
      font-weight: 500;
      align-items: center;
      justify-content: center;
      border: 0;
      background: none;
      padding: 0;
      align-self: center;
      grid-column: 3 / span 1;
    }

    .card--more.card--title {
      padding: 0;
      margin: 0;
      background: none;
      border: 0;
      text-align: left;
      font-size: 1em;
      cursor: pointer;
    }

    @media (min-width: 745px) {
      .card--title {
        grid-column: 1 / span 1;
      }
      .card--available {
        grid-column: 3 / span 1;
      }

      .pills {
        grid-column: 2 / span 1;
      }

      .card--more:not(.card--title) {
        grid-column: -2 / span 1;
      }
    }

    .card--body {
      line-height: 1.4;
      font-weight: 300;
      letter-spacing: 0.0178571429em;
      display: none;
    }

    .card--body[data-open] {
      display: block;
    }

    .card--details {
      grid-column: 1 / span 3;
    }

    .card--more:not(.card--title)[data-open] .card--more-icon {
      transform: rotate(45deg);
    }

    .card--more-icon {
      height: 1rem;
      width: 1rem;
      fill: currentColor;
    }

    .card--summary {
      opacity: 0.6;
      margin: 0;
      margin-top: 1rem;
      grid-column: 1 / span 1;
    }

    @media (min-width: 900px) {
      .card--with-summary {
        display: grid;
        grid-template-columns: min(calc(100% - (600px + 2rem)), 80ch) minmax(calc(600px + 1rem), 1fr);
        grid-gap: 1rem;
      }

      .card--with-summary .card--tables {
        grid-column: 2 / span 1;
      }
    }

    .card--location {
      width: 1.5em;
      height: auto;
    }

    .card--location__big {
      width: 2.5em;
    }

    /* .card--more::after {
      content: '+';
      display: inline-block;
      margin-left: 0.25rem;
    }

    [open] > .card--more::after {
      transform: rotate(45deg);
    } */

    .card--more::-webkit-details-marker {
      display: none;
    }

    .card--table {
      width: 100%;
      max-width: 400px;
      border: 1px solid #e8eaed;
      margin-top: 1rem;
      justify-self: center;
    }

    .card--table tr:nth-of-type(even),
    .card--table thead {
      background-color: #e8eaed;
    }

    .card--table td {
      border: 0;
    }

    .card--resources {
      grid-column: 1 / -1;
      display: grid;
      grid-gap: 1rem;
    }

    .card--resources h3 {
      font-size: 1.15em;
      line-height: 1.4;
      font-weight: 300;
      letter-spacing: 0.0125em;
      margin: 0;
      padding: 0;
      word-break: break-word;
    }

    .card--resources ul {
      margin: 0;
      padding-inline-start: 1rem;
    }

    @media (min-width: 700px) {
      .card--resources {
        grid-template-columns: 1fr 1fr;
      }
    }

    .pill {
      margin: 0.25rem 0.25rem;
      padding: 0 0.75em;
      background-color: #e8eaed;
      border-radius: 1em;
      font-size: 0.875em;
    }

    .pill--shipped {
      background-color: #aecbfa;
    }

    .pill--dev {
      background-color: #fde293;
    }

    .pill--ot {
      background-color: #a8dab5;
    }

    #filter-toggle {
      background: rgb(250, 250, 250);
      border: 0;
      padding: 0;
      height: 2.5rem;
      width: 2.5rem;
      padding: 0.5rem;
      cursor: pointer;
      align-self: flex-end;
      transform: translateX(2.5rem);
      border-radius: 0 0.5rem 0.5rem 0;
      box-shadow: 0px 3px 1px -2px rgba(0, 0, 0, 0.2), 0px 2px 2px 0px rgba(0, 0, 0, 0.14), 0px 1px 5px 0px rgba(0, 0, 0, 0.12);
      position: relative;
    }

    #filter-toggle::before {
      content: '';
      height: 100%;
      width: 10px;
      background-color: rgb(250, 250, 250);
      position: absolute;
      top: 0;
      left: -5px;
    }

    #filter-toggle[data-active]::after {
      content: '';
      height: 0.5rem;
      width: 0.5rem;
      background-color: red;
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      border-radius: 50%;
    }

    #filter-header {
      position: fixed;
      top: 0;
      left: 0;
      background: rgb(250, 250, 250);
      z-index: 20;
      transform: translateX(-100%);
      transition: transform 0.5s ease-in-out;
      display: flex;
      flex-direction: column;
      border-radius: 0 0 0.5rem 0;
      box-shadow: 0px 3px 1px -2px rgba(0, 0, 0, 0.2), 0px 2px 2px 0px rgba(0, 0, 0, 0.14), 0px 1px 5px 0px rgba(0, 0, 0, 0.12);
    }

    #filter-header[data-open] {
      transform: translateX(0);
    }

    #filter {
      margin-top: -2.5rem;
      padding: 1rem;
    }

    #filter label {
      display: block;
      margin-bottom: 0.25rem;
    }

    #filter input:not([type='submit']):not([type='reset']),
    #filter select {
      width: 100%;
    }
    #filter div + div {
      margin-top: 1rem;
    }

    .filter--controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-gap: 1rem;
    }

    [type='reset'] {
      border: 0;
      background: none;
      display: inline-flex;
      cursor: pointer;
      color: #6200ee;
      margin: 0;
      font-weight: 500;
      align-items: center;
      justify-content: center;
      border: 0;
      background: none;
      padding: 0;
      align-self: center;
      text-transform: uppercase;
    }

    [type='submit'] {
      background-color: #6200ee;
      color: #fff;
      box-shadow: 0px 3px 1px -2px rgba(0, 0, 0, 0.2), 0px 2px 2px 0px rgba(0, 0, 0, 0.14), 0px 1px 5px 0px rgba(0, 0, 0, 0.12);
      transition: box-shadow 280ms cubic-bezier(0.4, 0, 0.2, 1);
      padding: 0.625em 1em;
      font-weight: 500;
      align-items: center;
      justify-content: center;
      display: inline-flex;
      vertical-align: middle;
      border-radius: 4px;
      text-transform: uppercase;
      cursor: pointer;
      border: 0;
      -webkit-appearance: none;
      appearance: none;
    }

    .info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      grid-gap: 1rem;
      padding: 1rem 0;
    }

    #info {
      position: relative;
    }

    #info td:first-of-type {
      text-align: center;
      min-height: 1.5rem;
    }

    .site-header {
      background-color: #fbbc04;
      padding: 0.5rem 3.5rem;
      width: calc(100% + 7rem);
      transform: translateX(-3.5rem);
      position: relative;
    }

    .site-header::before {
      content: '';
      display: block;
      width: 0;
      height: 0;
      /* background-color: red; */
      position: absolute;
      bottom: -5vh;
      left: 0;
      border-left: 100vw solid transparent;
      border-right: 0px solid transparent;
      border-top: 5vh solid #fbbc04;
      z-index: -1;
    }

    .releases {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      width: 100%;
      /* margin-left: -1rem; */
      justify-content: center;
      flex-wrap: wrap;
      max-width: 100ch;
      /* background: white; */
      position: relative;
    }

    .release {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 1rem;
      background-color: white;
      padding: 0.5rem;
      border-radius: 4px;
    }

    .release--type,
    .release--date {
      margin: 0;
      /* font-weight: bold; */
      opacity: 1;
    }

    .release--type {
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }

    .release--title {
      font-size: 2.5rem;
      display: flex;
      flex-wrap: nowrap;
      align-items: center;
      margin: 0;
      font-weight: 300;
    }

    .release--date {
      margin-top: 1rem;
      text-align: center;
    }

    .release img {
      height: 1em;
      margin-right: 0.5rem;
    }
  </style>
  <body>
    {% from 'card.html' import card %}

    <header class="site-header">
      <h1>Fugu API Tracker</h1>
      <p>The <a href="https://developers.google.com/web/updates/capabilities">capabilities project</a>, also known as Project Fugu, is a cross-company effort to make it possible for web apps to do anything iOS, Android, or desktop apps can, by exposing the capabilities of these platforms to the web while maintaining user security, privacy, trust, and other core tenets of the web.</p>
      <p>If you'd like to work with this data programmatically, you can <a href="/js/data.json">download it</a> (approx. {{dataSize}}KB)</p>

      <details id="info">
        <summary>Icon Keys</summary>
        <div class="info">
          <table class="card--table">
            <caption>
              Icons
            </caption>
            <thead>
              <tr>
                <th>Icon</th>
                <th>Meaning</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>🐡</td>
                <td>Shipped, or expecting to ship, in Chrome</td>
              </tr>
              <tr>
                <td>🔮</td>
                <td>In origin trial</td>
              </tr>
              <tr>
                <td>🏴</td>
                <td>In developer trial</td>
              </tr>
              <tr>
                <td>
                  <div class="card--more">
                    <svg class="card--more-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                      <path d="M0 0h24v24H0V0z" fill="none"></path>
                      <path d="M20 13h-7v7h-2v-7H4v-2h7V4h2v7h7v2z"></path>
                    </svg>
                  </div>
                </td>
                <td>More info</td>
              </tr>
            </tbody>
          </table>

          <table class="card--table">
            <caption>
              Availability
            </caption>
            <thead>
              <tr>
                <th>Icon</th>
                <th>Meaning</th>
              </tr>
            </thead>
            <tbody>
              {% for platform in platforms %}
              <tr>
                <td><img class="card--location" src="/images/{{platform | slug}}.svg" alt="{{platform}}" /></td>
                <td>{{platform}}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    </header>

    <aside id="filter-header">
      <button id="filter-toggle" aria-label="Open filter">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M0 0h24m0 24H0" fill="none" />
          <path d="M7 6h10l-5.01 6.3L7 6zm-2.75-.39C6.27 8.2 10 13 10 13v6c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-6s3.72-4.8 5.74-7.39A.998.998 0 0018.95 4H5.04c-.83 0-1.3.95-.79 1.61z" />
          <path d="M0 0h24v24H0V0z" fill="none" />
        </svg>
      </button>
      <form action="" id="filter">
        <div>
          <label for="search">Search</label>
          <input type="text" id="search" name="search" />
        </div>
        <div>
          <label for="platform">Platform</label>
          <select name="platforms" id="platform" multiple size="{{platforms | length }}">
            {% for platform in platforms %}
            <option value="{{platform | lower}}">{{platform}}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="bug">Tracking bug</label>
          <input type="number" id="bug" step="1" name="bug" />
        </div>
        <div>
          <label for="version">Minimum Chrome version</label>
          <input type="number" name="version" min="{{versions.min}}" max="{{versions.max}}" step="1" id="version" />
        </div>

        <div class="filter--controls">
          <input type="reset" />
          <input type="submit" />
        </div>
      </form>
    </aside>

    <ol class="releases">
      <li class="release release__stable">
        <p class="release--type">Stable</p>
        <h3 class="release--title"><img src="https://chromestatus.com/static/img/chrome_logo.svg" alt="" />Chrome {{versions.stable}}</h3>
        {% for r in releases %} {% if r.release == versions.stable %}
        <p class="release--date" data-date="{{r.date}}">Stable: {{r.date | date }}</p>
        {% endif %} {% endfor %}
      </li>
      <li class="release">
        <p class="release--type">Beta</p>
        <h3 class="release--title"><img src="https://chromestatus.com/static/img/chrome_logo_beta.svg" alt="" />Chrome {{versions.beta}}</h3>
        {% for r in releases %} {% if r.release == versions.beta %}
        <p class="release--date" data-date="{{r.date}}">Stable: {{r.date | date }}</p>
        {% endif %} {% endfor %}
      </li>
      <li class="release">
        <p class="release--type">Dev</p>
        <h3 class="release--title"><img src="https://chromestatus.com/static/img/chrome_logo_dev.svg" alt="" />Chrome {{versions.dev}}</h3>
        {% for r in releases %} {% if r.release == versions.dev %}
        <p class="release--date" data-date="{{r.date}}">Stable: {{r.date | date }}</p>
        {% endif %} {% endfor %}
      </li>
    </ol>

    {% for type, items in apis %} {% if items.length %}
    <section>
      <h2>{{sections[type] | safe}}</h2>
      <ul class="cards">
        {% for api in items %} {{card(api, type | lower)}} {% endfor %}
      </ul>
    </section>
    {% endif %} {% endfor %}
    <script type="module">
      import Fuse from 'https://cdn.jsdelivr.net/npm/fuse.js@6.4.3/dist/fuse.esm.js';

      function toggleDetails(e) {
        e.preventDefault();
        const target = e.target.closest('.card--more');
        const details = e.target.closest('.card').querySelector('.card--body');
        const info = e.target.closest('.card').querySelector('.card--more:not(.card--title)');

        if (info.dataset.open) {
          delete info.dataset.open;
          delete details.dataset.open;
        } else {
          info.dataset.open = true;
          details.dataset.open = true;
        }
      }

      window.addEventListener('DOMContentLoaded', () => {
        const filterButton = document.querySelector('#filter-toggle');

        filterButton.addEventListener('click', e => {
          const parent = e.target.closest('#filter-header');
          if (parent.dataset.open) {
            e.target.closest('#filter-toggle').setAttribute('aria-label', 'Open filter');
            delete parent.dataset.open;
          } else {
            parent.dataset.open = true;
            e.target.closest('#filter-toggle').setAttribute('aria-label', 'Close filter');
          }
        });

        const cards = [...document.querySelectorAll('.card')].map(elem => {
          const card = {
            elem,
            title: elem.dataset.title,
            shipping: JSON.parse(elem.dataset.shipping),
            desc: elem.querySelector('.card--summary') ? elem.querySelector('.card--summary').textContent : '',
            status: elem.dataset.type,
            bug: elem.dataset.bug,
            where: JSON.parse(elem.dataset.where),
            pwa: elem.dataset.pwa === 'true',
          };
          elem.querySelectorAll('.card--more').forEach(el => el.addEventListener('click', toggleDetails));

          return card;
        });

        const fuse = new Fuse(cards, {
          keys: ['title', 'desc'],
          includeScore: true,
          minMatchCharLength: 2,
          includeMatches: true,
          ignoreLocation: true,
        });

        const filter = document.getElementById('filter');

        document.querySelectorAll('.release--date').forEach(r => {
          const d = new Date(r.dataset.date);
          const today = new Date();
          const diff = Math.ceil((d - today) / (1000 * 60 * 60 * 24));
          const short = d.toLocaleDateString('en-us', { year: 'numeric', month: 'short', day: 'numeric' });
          console.log(short);

          if (diff < 0) {
            r.innerHTML = `Stable: ${Math.abs(diff)} days ago <br/>(${short})`;
          } else {
            r.innerHTML = `Stable: ${diff} days <br/>(${short})`;
          }
        });

        init();

        // Init from search results
        function init() {
          const search = new URL(window.location).search;

          if (search) {
            const params = new URLSearchParams(search.substring(1));
            const toSearch = {
              version: params.get('version'),
              search: params.get('search'),
              platforms: params.get('platforms') ? JSON.parse(params.get('platforms')) : '',
              bug: params.get('bug'),
            };

            for (const elem of filter.querySelectorAll('[name]')) {
              const param = toSearch[elem.name];
              if (param) {
                if (elem.type === 'select-multiple') {
                  for (const item of param) {
                    elem.querySelector(`[value="${item}"]`).selected = true;
                  }
                } else {
                  elem.value = param;
                }
              }
            }

            filterResults(toSearch);
          }
        }

        /**
         * @param {object} options - Options to filter on
         * @param {string} [options.version] - Minimum version to filter on
         * @param {string} [options.search] - Search string to look for
         * @param {string[]} [options.platforms] - Array of possible platforms it could have launched on
         * @param {string} [options.bug] - Bug number
         */
        function filterResults({ version, search, platforms, bug } = options) {
          const searchParams = new URLSearchParams();
          searchParams.set('version', version);
          searchParams.set('search', search);
          searchParams.set('platforms', JSON.stringify(platforms));
          searchParams.set('bug', bug);

          window.history.pushState('', '', `?${searchParams.toString()}`);

          document.querySelector('#filter-toggle').dataset.active = true;

          const s = fuse.search(search).filter(s => s.score <= 0.25);
          const results = (s.length ? s.map(i => i.item) : cards)
            // Version
            .filter(card => {
              if (isNaN(version)) return true;

              if (card.status === 'shipped') {
                if (card.shipping === false) return true;
                if (card.shipping?.ship >= version) return true;
              }
              if (card.shipping?.ot?.start >= version) return true;
              if (card.shipping?.dev >= version) return true;

              return false;
            })
            // Platform
            .filter(card => {
              if (platforms.length === 0) return true;

              let filtered = [];
              if (Array.isArray(card.where)) {
                filtered = filtered.concat(card.where);
              }
              if (card.pwa) {
                filtered.push('pwa');
              }

              return filtered.length >= 0 && filtered.filter(w => platforms.includes(w.toLocaleLowerCase())).length > 0;
            });

          for (const card of cards) {
            let display = false;
            if (results.find(c => c.bug === card.bug)) {
              display = true;
            }

            if (display) {
              card.elem.style.display = 'block';
            } else {
              card.elem.style.display = 'none';
            }
          }
        }

        filter.addEventListener('submit', e => {
          e.preventDefault();
          const data = new FormData(e.target);

          const version = parseInt(data.get('version'));
          const search = data.get('search');
          const platforms = data.getAll('platforms').map(p => p.toLocaleLowerCase());
          const bug = data.get('bug');

          return filterResults({ version, search, platforms, bug });
        });

        filter.addEventListener('reset', e => {
          for (const card of cards) {
            card.elem.style.display = 'block';
          }

          delete document.querySelector('#filter-toggle').dataset.active;

          if (location.search) {
            history.pushState('', '', location.href.replace(location.search, ''));
          }
        });
      });
    </script>
  </body>
</html>
