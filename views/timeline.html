<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timeline</title>
    <link rel="stylesheet" href="/css/header.css" />
    <link rel="stylesheet" href="/css/card.css" />
    <link rel="stylesheet" href="/css/timeline.css" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <style>
      body {
        background: hsl(0, 0%, 95%);
      }

      .timeline-grid {
        grid-template-columns: repeat({{releases | length}}, 25vw);
      }

      .timeline-grid--background {
        background-image:
          {{releases | buildBackgroundGradient(versions)}};
        background-size: 100%, 100%, 100%, {{releases | calculatedSize(2)}};
        background-repeat: repeat-x;
      }

      .copy {
        border: 0;
        background: none;
        padding: 0;
        margin: 0;
        margin-left: 0.5rem;
        font-size: 1em;
        cursor: pointer;
      }

      .copy svg {
        height: 1em;
      }
    </style>
  </head>
  <script type="module">
    function toggleDetails(e) {
      e.preventDefault();
      const target = e.target.closest('.card--more');
      const details = e.target.closest('.card').querySelector('.card--body');
      const info = e.target.closest('.card').querySelector('.card--more:not(.card--title)');

      if (info.dataset.open) {
        delete info.dataset.open;
        delete details.dataset.open;
      } else {
        info.dataset.open = true;
        details.dataset.open = true;
      }
    }

    function copyURL(e) {
      const target = e.target.closest('.copy');
      const url = target.dataset.url;
      const temp = document.createElement('input');
      document.body.appendChild(temp);
      temp.value = url;
      temp.select();
      document.execCommand('copy');
      temp.parentNode.removeChild(temp);
    }

    window.addEventListener('DOMContentLoaded', () => {
      for (const copy of document.querySelectorAll('.copy')) {
        copy.addEventListener('click', copyURL);
      }

      const cards = [...document.querySelectorAll('.card__holder')].map((elem) => {
        const card = {
          elem,
          title: elem.dataset.title,
          shipping: JSON.parse(elem.dataset.shipping),
          desc: elem.querySelector('.card--summary') ? elem.querySelector('.card--summary').textContent : '',
          status: elem.dataset.type,
          bug: elem.dataset.bug,
          where: JSON.parse(elem.dataset.where),
          pwa: elem.dataset.pwa === 'true',
        };

        elem.querySelectorAll('.card--more').forEach((el) => el.addEventListener('click', toggleDetails));

        return card;
      });
      window.cards = cards;
    });
  </script>
  <body>
    <header class="site-header">
      <h1>Fugu API Tracker - Timeline View</h1>
      <p>The <a href="https://developers.google.com/web/updates/capabilities">capabilities project</a>, also known as Project Fugu, is a cross-company effort to make it possible for web apps to do anything iOS, Android, or desktop apps can, by exposing the capabilities of these platforms to the web while maintaining user security, privacy, trust, and other core tenets of the web.</p>

      <p>If you'd like to work with this data programmatically, you can <a href="/js/data.json">download it</a> (approx. {{dataSize}}KB)</p>

      <p>This timeline view works best on large screens and only shows the subset of APIs that are available to test. To see all APIs, or if this view doesn't work for your screen size, swap to our <a href="/">normal view</a>.</p>
    </header>

    {% from 'filters.html' import filter %} {% from 'info.html' import info %} {{filter(platforms, versions)}} {{info(platforms)}} {% from 'card.html' import timelineCard %}

    <div class="timeline-wrapper">
      <ul id="timeline" class="timeline timeline-grid timeline-grid--background">
        <li class="timeline-grid timeline-header">
          {% for r in releases %} {% set classes = 'release' %} {% if r.release == versions.stable %} {% set classes = 'release release--stable' %} {% elseif r.release == versions.beta %} {% set classes = 'release release--beta' %} {% elseif r.release == versions.dev %} {% set classes = 'release release--dev' %} {% endif %}

          <div class="{{classes}}">
            {% if r.release == versions.stable %}
            <p class="release--type">Stable</p>
            <p class="release--title"><img src="https://chromestatus.com/static/img/chrome_logo.svg" alt="" />Chrome {{r.release}}</p>
            {% elseif r.release == versions.beta %}
            <p class="release--type">Beta</p>
            <p class="release--title"><img src="https://chromestatus.com/static/img/chrome_logo_beta.svg" alt="" />Chrome {{r.release}}</p>
            {% elseif r.release == versions.dev %}
            <p class="release--type">Dev</p>
            <p class="release--title"><img src="https://chromestatus.com/static/img/chrome_logo_dev.svg" alt="" />Chrome {{r.release}}</p>
            {% elseif r.release > versions.dev %}
            <p class="release--type"></p>
            <p class="release--title"><img src="https://chromestatus.com/static/img/chrome_logo_dev.svg" alt="" />Chrome {{r.release}}</p>
            {% else %}
            <p class="release--type"></p>
            <p class="release--title"><img src="https://chromestatus.com/static/img/chrome_logo.svg" alt="" />Chrome {{r.release}}</p>
            {% endif %}
            <p class="release--date" data-date="{{r.date}}">{{r.date | date }}</p>
          </div>
          {% endfor %}
        </li>
        {% for api in apis | timelineRows %} {{ timelineCard(api, releases, versions, loop)}} {% endfor %}
      </ul>
    </div>

    <script type="module">
      window.addEventListener('DOMContentLoaded', () => {
        const timeline = document.querySelector('#timeline');
        const items = parseInt('{{releases | length }}');
        const width = timeline.scrollWidth;
        const step = width / items;
        const scoot = parseInt('{{versions.stable - versions.min}}');

        const header = document.querySelector('.site-header');

        timeline.style.height = `calc(${window.innerHeight - header.offsetHeight}px - 3.5rem)`;

        timeline.scrollTo((scoot - 1) * step, 0);

        let offset = timeline.scrollLeft / width;

        // Update offset on scroll
        timeline.addEventListener('scroll', () => {
          offset = timeline.scrollLeft / timeline.scrollWidth;
        });

        // Update scroll on resize
        window.addEventListener('resize', () => {
          timeline.style.height = `calc(${window.innerHeight - header.offsetHeight}px - 3.5rem)`;
          timeline.scrollTo(timeline.scrollWidth * offset, 0);
        });

        // From Now dates
        document.querySelectorAll('.release--date').forEach((r) => {
          const d = new Date(r.dataset.date);
          const today = new Date();
          const diff = Math.ceil((d - today) / (1000 * 60 * 60 * 24));
          const short = d.toLocaleDateString('en-us', { year: 'numeric', month: 'short', day: 'numeric' });

          if (diff < 0) {
            r.innerHTML = `${Math.abs(diff).toLocaleString()} days ago <br/>(${short})`;
          } else {
            r.innerHTML = `In ${diff.toLocaleString()} days <br/>(${short})`;
          }
        });
      });
    </script>
  </body>
</html>
